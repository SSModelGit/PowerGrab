(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 10.2' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     13692,        330]
NotebookOptionsPosition[     13437,        316]
NotebookOutlinePosition[     13791,        332]
CellTagsIndexPosition[     13748,        329]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[{
 RowBox[{"Needs", "[", "\"\<WSMLink`\>\"", "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"components", "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{
     "\"\<F_A\>\"", "\[Element]", "\"\<Modelica.Blocks.Sources.Ramp\>\""}], 
     ",", " ", 
     RowBox[{
     "\"\<F_P\>\"", "\[Element]", 
      "\"\<Modelica.Blocks.Sources.Constant\>\""}], ",", " ", 
     RowBox[{
     "\"\<RJT\>\"", "\[Element]", "\"\<Modelica.Blocks.Sources.Ramp\>\""}], 
     ",", 
     RowBox[{
     "\"\<LT\>\"", "\[Element]", "\"\<Modelica.Blocks.Sources.Constant\>\""}],
      ",", " ", 
     RowBox[{
     "\"\<BMJEC\>\"", "\[Element]", 
      "\"\<PowerGrab.Components.BoneMuscleJointExperimentalComponent\>\""}], 
     ",", " ", 
     RowBox[{
     "\"\<world\>\"", "\[Element]", 
      "\"\<Modelica.Mechanics.MultiBody.World\>\""}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"connections", "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"\"\<F_A.y\>\"", "\[Rule]", "\"\<BMJEC.F_A\>\""}], ",", 
     RowBox[{"\"\<F_P.y\>\"", "\[Rule]", "\"\<BMJEC.F_P\>\""}], ",", 
     RowBox[{"\"\<LT.y\>\"", "\[Rule]", "\"\<BMJEC.LoadTorque\>\""}], ",", 
     " ", 
     RowBox[{"\"\<RJT.y\>\"", "\[Rule]", "\"\<BMJEC.RevoluteJointTheta\>\""}],
      ",", " ", 
     RowBox[{"\"\<world.frame_b\>\"", "\[Rule]", "\"\<BMJEC.frame_a\>\""}]}], 
    "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"mmodel", "=", 
   RowBox[{"WSMConnectComponents", "[", 
    RowBox[{"\"\<JTest\>\"", ",", "components", ",", "connections"}], "]"}]}],
   ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"tauComponents", "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{
     "\"\<F_A\>\"", "\[Element]", "\"\<Modelica.Blocks.Sources.Ramp\>\""}], 
     ",", " ", 
     RowBox[{
     "\"\<F_P\>\"", "\[Element]", 
      "\"\<Modelica.Blocks.Sources.Constant\>\""}], ",", " ", 
     RowBox[{
     "\"\<RJT\>\"", "\[Element]", "\"\<Modelica.Blocks.Sources.Ramp\>\""}], 
     ",", 
     RowBox[{
     "\"\<LT\>\"", "\[Element]", "\"\<Modelica.Blocks.Sources.Constant\>\""}],
      ",", " ", 
     RowBox[{
     "\"\<BMJEC\>\"", "\[Element]", 
      "\"\<PowerGrab.Components.BoneMuscleJointExperimentalComponent\>\""}], 
     ",", " ", 
     RowBox[{
     "\"\<world\>\"", "\[Element]", 
      "\"\<Modelica.Mechanics.MultiBody.World\>\""}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"tauConnections", "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"\"\<F_A.y\>\"", "\[Rule]", "\"\<BMJEC.F_A\>\""}], ",", 
     RowBox[{"\"\<F_P.y\>\"", "\[Rule]", "\"\<BMJEC.F_P\>\""}], ",", 
     RowBox[{"\"\<LT.y\>\"", "\[Rule]", "\"\<BMJEC.LoadTorque\>\""}], ",", 
     " ", 
     RowBox[{"\"\<RJT.y\>\"", "\[Rule]", "\"\<BMJEC.RevoluteJointTheta\>\""}],
      ",", " ", 
     RowBox[{"\"\<world.frame_b\>\"", "\[Rule]", "\"\<BMJEC.frame_a\>\""}]}], 
    "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"taumodel", "=", 
   RowBox[{"WSMConnectComponents", "[", 
    RowBox[{"\"\<TauTest\>\"", ",", "components", ",", "connections"}], 
    "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"tauList", "=", 
   RowBox[{"{", "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"tau", "=", "3"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"g", "=", "0"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"While", "[", 
  RowBox[{
   RowBox[{"tau", "\[LessEqual]", "5"}], ",", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"thetaList", "=", 
     RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
    RowBox[{"theta", "=", "0.1"}], ";", "\[IndentingNewLine]", 
    RowBox[{"While", "[", 
     RowBox[{
      RowBox[{"theta", "\[LessEqual]", " ", "1.5"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"fP", "=", "0.01"}], ";", "\[IndentingNewLine]", 
       RowBox[{"vectorList", "=", 
        RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"phiTrials", "=", "1"}], ";", "\[IndentingNewLine]", 
       RowBox[{"notFPTracker", "=", "True"}], ";", "\[IndentingNewLine]", 
       RowBox[{"desiredLimit", "=", "7"}], ";", "\[IndentingNewLine]", 
       RowBox[{"trialLimit", "=", "10000"}], ";", "\[IndentingNewLine]", 
       RowBox[{"fPList", "=", 
        RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"While", "[", 
        RowBox[{
         RowBox[{"phiTrials", "\[LessEqual]", "trialLimit"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Print", "[", 
           RowBox[{
           "\"\<tau = \>\"", ",", " ", "tau", ",", " ", "\"\<, theta = \>\"", 
            ",", " ", "theta", ",", " ", "\"\<, Trial number = \>\"", ",", 
            " ", "phiTrials", ",", " ", "\"\<, fP = \>\"", ",", " ", "fP"}], 
           "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{"AppendTo", "[", 
           RowBox[{"fPList", ",", "fP"}], "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{"WSMSetValues", "[", 
           RowBox[{"mmodel", ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"\"\<F_A.duration\>\"", "\[Rule]", "10"}], ",", 
              RowBox[{"\"\<F_P.k\>\"", "\[Rule]", "fP"}], ",", 
              RowBox[{"\"\<LT.k\>\"", "\[Rule]", "tau"}], ",", 
              RowBox[{"\"\<RJT.duration\>\"", "\[Rule]", "0"}], ",", 
              RowBox[{"\"\<RJT.height\>\"", "\[Rule]", "0"}], ",", 
              RowBox[{"\"\<RJT.offset\>\"", "\[Rule]", "theta"}], ",", 
              RowBox[{"\"\<world.g\>\"", "\[Rule]", " ", "g"}], ",", 
              RowBox[{
              "\"\<BMJEC.phi_0_restrained\>\"", "\[Rule]", "theta"}]}], 
             "}"}]}], "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{"MM", "=", 
           RowBox[{"WSMSimulate", "[", 
            RowBox[{"mmodel", ",", 
             RowBox[{"{", 
              RowBox[{"0", ",", "10"}], "}"}]}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"tauFunction", "=", 
           RowBox[{"First", "[", 
            RowBox[{"MM", "[", 
             RowBox[{"{", "\"\<BMJEC.position2.flange.tau\>\"", "}"}], "]"}], 
            "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"fAValue", "=", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"t", "/.", 
              RowBox[{"FindRoot", "[", 
               RowBox[{
                RowBox[{"tauFunction", "[", "t", "]"}], ",", 
                RowBox[{"{", 
                 RowBox[{"t", ",", "0.1"}], "}"}]}], "]"}]}], ")"}], "/", 
            "10"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
            "0.01", "\[LessEqual]", " ", "fAValue", "\[LessEqual]", " ", 
             "1"}], ",", 
            RowBox[{"fAWorks", "=", "True"}], ",", 
            RowBox[{"fAWorks", "=", "False"}]}], "]"}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{"notFPTracker", ",", "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{"fAWorks", ",", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"notFPTracker", "=", "False"}], ";", 
               "\[IndentingNewLine]", 
               RowBox[{"If", "[", 
                RowBox[{
                 RowBox[{"phiTrials", "\[LessEqual]", " ", "desiredLimit"}], 
                 ",", 
                 RowBox[{"trialLimit", "=", "desiredLimit"}], ",", 
                 RowBox[{"trialLimit", "=", "desiredLimit"}]}], "]"}]}], ",", 
              
              RowBox[{"notFPTracker", "=", "True"}]}], "]"}], ",", "0"}], 
           "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{"fAWorks", ",", 
            RowBox[{"ansList", "=", 
             RowBox[{"{", "fP", "}"}]}], ",", 
            RowBox[{"ansList", "=", 
             RowBox[{"{", "}"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{"fAWorks", ",", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"WSMSetValues", "[", 
              RowBox[{"taumodel", ",", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"\"\<F_A.duration\>\"", "\[Rule]", "0"}], ",", 
                 RowBox[{"\"\<F_A.height\>\"", "\[Rule]", "0"}], ",", 
                 RowBox[{"\"\<F_A.offset\>\"", "\[Rule]", "fAValue"}], ",", 
                 RowBox[{"\"\<F_P.k\>\"", "\[Rule]", "fP"}], ",", 
                 RowBox[{"\"\<LT.k\>\"", "\[Rule]", "tau"}], ",", 
                 RowBox[{"\"\<RJT.duration\>\"", "\[Rule]", "10"}], ",", 
                 RowBox[{"\"\<RJT.height\>\"", "\[Rule]", "0.1"}], ",", 
                 RowBox[{"\"\<RJT.offset\>\"", "\[Rule]", 
                  RowBox[{"theta", "-", "0.05"}]}], ",", 
                 RowBox[{"\"\<world.g\>\"", "\[Rule]", " ", "g"}], ",", 
                 RowBox[{"\"\<BMJEC.phi_0_restrained\>\"", "\[Rule]", 
                  RowBox[{"theta", "-", "0.05"}]}]}], "}"}]}], "]"}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"tauM", "=", 
              RowBox[{"WSMSimulate", "[", 
               RowBox[{"taumodel", ",", 
                RowBox[{"{", 
                 RowBox[{"0", ",", "10"}], "}"}]}], "]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"tauStiffnessFunction", "=", 
              RowBox[{"First", "[", 
               RowBox[{"tauM", "[", 
                RowBox[{"{", "\"\<BMJEC.position2.flange.tau\>\"", "}"}], 
                "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"phiStiffnessFunction", "=", 
              RowBox[{"First", "[", 
               RowBox[{"tauM", "[", 
                RowBox[{"{", "\"\<BMJEC.position2.flange.phi\>\"", "}"}], 
                "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"stiffness", "=", 
              RowBox[{
               RowBox[{
                RowBox[{"tauStiffnessFunction", "'"}], "[", 
                RowBox[{"t", "/.", 
                 RowBox[{"FindRoot", "[", 
                  RowBox[{
                   RowBox[{"tauStiffnessFunction", "[", "t", "]"}], ",", 
                   RowBox[{"{", 
                    RowBox[{"t", ",", "1"}], "}"}]}], "]"}]}], "]"}], "/", 
               RowBox[{
                RowBox[{"phiStiffnessFunction", "'"}], "[", 
                RowBox[{"t", "/.", 
                 RowBox[{"FindRoot", "[", 
                  RowBox[{
                   RowBox[{"tauStiffnessFunction", "[", "t", "]"}], ",", 
                   RowBox[{"{", 
                    RowBox[{"t", ",", "1"}], "}"}]}], "]"}]}], "]"}]}]}], ";", 
             RowBox[{"AppendTo", "[", 
              RowBox[{"ansList", ",", "stiffness"}], "]"}]}], ",", "0"}], 
           "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{"fAWorks", ",", 
            RowBox[{"fP", "+=", "0.1"}], ",", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{"fAValue", ">", "1"}], ",", 
               RowBox[{"fP", "-=", "0.1"}], ",", "0"}], "]"}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"If", "[", 
              RowBox[{
               RowBox[{"fAValue", "<", "0.01"}], ",", 
               RowBox[{"fP", "+=", "0.1"}], ",", "0"}], "]"}]}]}], "]"}], ";",
           "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Position", "[", 
              RowBox[{"fPList", ",", "fP"}], "]"}], "\[NotEqual]", 
             RowBox[{"{", "}"}]}], ",", 
            RowBox[{"fP", "+=", "0.05"}], ",", "0"}], "]"}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"phiTrials", "++"}], ";", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{"fAWorks", ",", 
            RowBox[{"PrependTo", "[", 
             RowBox[{"ansList", ",", "fAValue"}], "]"}], ",", "0"}], "]"}], 
          ";", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{"fAWorks", ",", 
            RowBox[{"AppendTo", "[", 
             RowBox[{"vectorList", ",", "ansList"}], "]"}], ",", "0"}], 
           "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"PrependTo", "[", 
        RowBox[{"vectorList", ",", "theta"}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"AppendTo", "[", 
        RowBox[{"thetaList", ",", "vectorList"}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"theta", "+=", "0.2"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
    
    RowBox[{"PrependTo", "[", 
     RowBox[{"thetaList", ",", "tau"}], "]"}], ";", "\[IndentingNewLine]", 
    RowBox[{"AppendTo", "[", 
     RowBox[{"tauList", ",", "thetaList"}], "]"}], ";", "\[IndentingNewLine]", 
    RowBox[{"tau", "++"}]}]}], 
  "]"}], "\[IndentingNewLine]", "tauList"}], "Input",
 CellChangeTimes->{{3.6651887218045807`*^9, 3.6651887425501137`*^9}}]
},
WindowSize->{808, 619},
WindowMargins->{{12, Automatic}, {Automatic, 24}},
FrontEndVersion->"10.2 for Mac OS X x86 (32-bit, 64-bit Kernel) (July 29, \
2015)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 12875, 294, 1236, "Input"]
}
]
*)

(* End of internal cache information *)
